datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

generator client {
    provider = "prisma-client-js"
}

enum GardenPeriod {
    DAY
    WEEK
    MONTH
    YEAR
}

enum GardenStatus {
    PENDING
    GENERATING
    READY
    FAILED
}

model Token {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id],  onDelete: Cascade )
  userId    String
  token     String   @unique
  type      String   // "verify-email" | "reset-password"
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())
}

model User {
    id           String       @id @default(uuid())
    email        String       @unique
    passwordHash String?
    createdAt    DateTime     @default(now())
    displayName  String       @default("Anonymous")
    entries      DiaryEntry[]
    gardens      Garden[]
    userKey      UserKey?
    googleId     String?  @unique // Google "sub" claim (user id)
    timezone        String @default("UTC")
    dayRolloverHour Int    @default(0)

    emailVerified  Boolean  @default(false)
    tokens         Token[]
    notifyWeeklyGarden  Boolean @default(true)
    notifyMonthlyGarden Boolean @default(true)
    notifyYearlyGarden  Boolean @default(true)

    stripeCustomerId String?
    isPremium        Boolean @default(false)
    premiumSince     DateTime?
}

model DiaryEntry {
    id         String   @id @default(uuid())
    text       String
    dayKey     String
    createdAt  DateTime @default(now())
    iv         Bytes?
    authTag    Bytes?
    ciphertext Bytes?
    keyVersion Int      @default(1)
    userId     String
    user       User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)

    @@unique([userId, dayKey])
    @@index([dayKey])
    @@index([userId, dayKey])
    @@index([userId, createdAt])
    @@map("Entry")
}

model Garden {
  id        String       @id @default(uuid())
  period    GardenPeriod @default(DAY)
  periodKey String
  // Image data
  shareId   String?      @unique
  imageUrl  String?
  publicId  String?      @db.VarChar(512)
  // ── Generation metadata ───────────────
  valence             String   @default("")
  primaryEmotion      String   @default("")
  secondaryEmotions   String[] @default([])
  intensity           Int      @default(0)
  normalisedIntensity Int      @default(0)
  intensityBand       String   @default("")
  archetype           String   @default("")
  earnestness         String   @default("")
  prompt              String   @default("")
  //encrypted summary support
  summary             String?
  summaryIv           Bytes?
  summaryAuthTag      Bytes?
  summaryCiphertext   Bytes?
  summaryKeyVersion   Int?     @default(1)

  status    GardenStatus @default(READY)
  progress  Int          @default(0)

  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  userId    String
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([userId, period, periodKey])
}


model UserKey {
    id        String   @id @default(uuid())
    userId    String   @unique
    edek      Bytes
    keyId     String
    version   Int      @default(1)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    user      User     @relation(fields: [userId], references: [id],  onDelete: Cascade)
}
